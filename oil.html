<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>최저가 주유소 찾기</title>
    <style>
        #map { width: 100%; height: 400px; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>내 주변 5km 최저가 주유소</h1>
    <div id="map"></div>
    <div id="result"></div>

    <!-- 다음 지도 API 스크립트 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9b8113591f35c3409335bdb4b5ee5613"></script>
    <script>
        // 사용자 위치 가져오기
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showGasStations, showError);
        } else {
            alert("위치 정보를 지원하지 않는 브라우저입니다.");
        }

        // 위치 가져오기 성공 시
        function showGasStations(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            // 다음 지도 초기화
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(userLat, userLon),
                level: 5 // 지도 확대 레벨
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            // 사용자 위치 마커
            const userMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(userLat, userLon),
                map: map
            });

            // 오피넷 API 호출
            const apiKey = 'F250405240';
            const radius = 5000; // 5km
            const url = `http://www.opinet.co.kr/api/aroundAll.do?code=${apiKey}&x=${userLon}&y=${userLat}&radius=${radius}&sort=1&prodcd=B027&out=json`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const stations = data.RESULT.OIL;
                    if (!stations || stations.length === 0) {
                        document.getElementById('result').innerHTML = "5km 내 주유소가 없습니다.";
                        return;
                    }

                    // 최저가 주유소 찾기 (휘발유 기준: B027)
                    let cheapestStation = stations.reduce((prev, curr) =>
                        parseInt(prev.PRICE) < parseInt(curr.PRICE) ? prev : curr
                    );

                    // 거리 계산 (Haversine 공식)
                    const distance = calculateDistance(userLat, userLon, cheapestStation.GIS_Y_COOR, cheapestStation.GIS_X_COOR);

                    // 결과 출력
                    document.getElementById('result').innerHTML = `
                        <h2>최저가 주유소</h2>
                        <p>이름: ${cheapestStation.OS_NM}</p>
                        <p>가격: ${cheapestStation.PRICE}원 (휘발유)</p>
                        <p>거리: ${distance.toFixed(2)}km</p>
                        <p>주소: ${cheapestStation.ADDR}</p>
                    `;

                    // 주유소 위치 지도에 표시
                    const stationPosition = new kakao.maps.LatLng(cheapestStation.GIS_Y_COOR, cheapestStation.GIS_X_COOR);
                    const stationMarker = new kakao.maps.Marker({
                        position: stationPosition,
                        map: map
                    });
                })
                .catch(error => console.error('오피넷 API 오류:', error));
        }

        // Haversine 공식으로 거리 계산 (단위: km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 지구 반지름 (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // 위치 가져오기 실패 시
        function showError(error) {
            alert("위치 정보를 가져오지 못했습니다: " + error.message);
        }
    </script>
</body>
</html>