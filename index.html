<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>내 주변 5km 주유소</title>
    <style>
        #map { width: 100%; height: 400px; border: 1px solid #ccc; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>내 주변 5km 주유소</h1>
    <div id="map"></div>
    <div id="result"></div>

    <!-- 다음 지도 API -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9b8113591f35c3409335bdb4b5ee5613"></script>
    <script>
        kakao.maps.load(() => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showGasStations, showError);
            } else {
                document.getElementById('result').innerHTML = "위치 정보를 지원하지 않는 브라우저입니다.";
            }
        });

        function showGasStations(position) {
            const userLat = position.coords.latitude; // WGS84 위도
            const userLon = position.coords.longitude; // WGS84 경도

            // WGS84 -> KATEC 변환
            const katec = wgs84ToKatec(userLon, userLat);
            console.log('현재 위치 (WGS84):', { latitude: userLat, longitude: userLon });
            console.log('KATEC 변환 좌표:', katec);

            // 지도 초기화 (5km 반경에 맞게 레벨 조정)
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(userLat, userLon),
                level: 5 // 5km 반경에 적합
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            // 사용자 위치 마커
            new kakao.maps.Marker({
                position: new kakao.maps.LatLng(userLat, userLon),
                map: map,
                title: "현재 위치"
            });

            // 오피넷 API 호출 (KATEC 좌표 사용)
            const apiKey = 'F250405240';
            const radius = 5000; // 5km (API 최대값)
            const baseUrl = `http://www.opinet.co.kr/api/aroundAll.do?code=${apiKey}&x=${katec.x}&y=${katec.y}&radius=${radius}&sort=1&prodcd=B027&out=json`;
            const proxyUrl = `https://cors-anywhere.herokuapp.com/${baseUrl}`;

            fetch(proxyUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP 오류: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('오피넷 API 응답:', data);

                    const stations = data.RESULT?.OIL;
                    if (!stations || stations.length === 0) {
                        document.getElementById('result').innerHTML = "5km 내 주유소가 없습니다.";
                        console.log('주유소 데이터 없음 - KATEC 위치:', katec);
                        return;
                    }

                    // 모든 주유소 정보 표시
                    let resultHtml = '<h2>검색된 주유소 목록</h2>';
                    stations.forEach(station => {
                        const distance = calculateDistance(userLat, userLon, station.GIS_Y_COOR, station.GIS_X_COOR);
                        resultHtml += `
                            <div>
                                <p>이름: ${station.OS_NM}</p>
                                <p>가격: ${station.PRICE}원 (휘발유)</p>
                                <p>거리: ${distance.toFixed(2)}km</p>
                                <p>주소: ${station.NEW_ADR || station.VAN_ADR}</p>
                                <hr>
                            </div>
                        `;

                        new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(station.GIS_Y_COOR, station.GIS_X_COOR),
                            map: map,
                            title: `${station.OS_NM} - ${station.PRICE}원`
                        });
                    });
                    document.getElementById('result').innerHTML = resultHtml;
                })
                .catch(error => {
                    console.error('오피넷 API 오류:', error);
                    document.getElementById('result').innerHTML = `주유소 정보를 불러오지 못했습니다: ${error.message}`;
                });
        }

        // WGS84 -> KATEC 변환 함수 (정확한 공식 적용)
        function wgs84ToKatec(lon, lat) {
            const PI = Math.PI;
            const DEGRAD = PI / 180.0;

            // KATEC 파라미터 (한국 기준)
            const re = 6371.00877; // 지구 반경 [km]
            const grid = 5.0; // 격자 간격 [km]
            const slat1 = 30.0 * DEGRAD; // 표준 위도 1
            const slat2 = 60.0 * DEGRAD; // 표준 위도 2
            const olon = 126.0 * DEGRAD; // 기준 경도
            const olat = 38.0 * DEGRAD;  // 기준 위도
            const xo = 210 / grid; // X 오프셋
            const yo = 675 / grid; // Y 오프셋

            let sn = Math.tan(PI * 0.25 + slat2 * 0.5) / Math.tan(PI * 0.25 + slat1 * 0.5);
            sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
            let sf = Math.tan(PI * 0.25 + slat1 * 0.5);
            sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
            let ro = Math.tan(PI * 0.25 + olat * 0.5);
            ro = re * sf / Math.pow(ro, sn);

            let ra = Math.tan(PI * 0.25 + lat * DEGRAD * 0.5);
            ra = re * sf / Math.pow(ra, sn);
            let theta = lon * DEGRAD - olon;
            if (theta > PI) theta -= 2.0 * PI;
            if (theta < -PI) theta += 2.0 * PI;
            theta *= sn;

            const x = ra * Math.sin(theta) + xo;
            const y = ro - ra * Math.cos(theta) + yo;
            return { x: x * 1000, y: y * 1000 }; // 미터 단위로 변환
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function showError(error) {
            document.getElementById('result').innerHTML = "위치 정보를 가져오지 못했습니다: " + error.message;
            console.error('Geolocation 오류:', error);
        }
    </script>
</body>
</html>
