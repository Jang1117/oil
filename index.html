<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>최저가 주유소 찾기</title>
    <style>
        #map { width: 100%; height: 400px; border: 1px solid #ccc; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>내 주변 30km 최저가 주유소</h1>
    <div id="map"></div>
    <div id="result"></div>

    <!-- 다음 지도 API -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9b8113591f35c3409335bdb4b5ee5613"></script>
    <script>
        kakao.maps.load(() => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showGasStations, showError);
            } else {
                document.getElementById('result').innerHTML = "위치 정보를 지원하지 않는 브라우저입니다.";
            }
        });

        function showGasStations(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            // 지도 초기화 (30km 반경에 맞게 레벨 조정)
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(userLat, userLon),
                level: 8 // 30km를 보기 위해 더 넓은 범위
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            // 사용자 위치 마커
            new kakao.maps.Marker({
                position: new kakao.maps.LatLng(userLat, userLon),
                map: map
            });

            // 오피넷 API 호출 (반경 30km)
            const apiKey = 'F250405240';
            const radius = 30000; // 30km = 30000m
            const baseUrl = `http://www.opinet.co.kr/api/aroundAll.do?code=${apiKey}&x=${userLon}&y=${userLat}&radius=${radius}&sort=1&prodcd=B027&out=json`;
            const proxyUrl = `https://cors-anywhere.herokuapp.com/${baseUrl}`;

            fetch(proxyUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP 오류: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('오피넷 API 응답:', data); // 디버깅용: 전체 응답 확인
                    const stations = data.RESULT?.OIL;
                    if (!stations || stations.length === 0) {
                        document.getElementById('result').innerHTML = "30km 내 주유소가 없습니다.";
                        console.log('주유소 데이터 없음 - 위치:', userLat, userLon);
                        return;
                    }

                    let cheapestStation = stations.reduce((prev, curr) =>
                        parseInt(prev.PRICE) < parseInt(curr.PRICE) ? prev : curr
                    );

                    const distance = calculateDistance(userLat, userLon, cheapestStation.GIS_Y_COOR, cheapestStation.GIS_X_COOR);

                    document.getElementById('result').innerHTML = `
                        <h2>최저가 주유소</h2>
                        <p>이름: ${cheapestStation.OS_NM}</p>
                        <p>가격: ${cheapestStation.PRICE}원 (휘발유)</p>
                        <p>거리: ${distance.toFixed(2)}km</p>
                        <p>주소: ${cheapestStation.ADDR}</p>
                    `;

                    new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(cheapestStation.GIS_Y_COOR, cheapestStation.GIS_X_COOR),
                        map: map
                    });
                })
                .catch(error => {
                    console.error('오피넷 API 오류:', error);
                    document.getElementById('result').innerHTML = `주유소 정보를 불러오지 못했습니다: ${error.message}`;
                });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function showError(error) {
            document.getElementById('result').innerHTML = "위치 정보를 가져오지 못했습니다: " + error.message;
        }
    </script>
</body>
</html>
